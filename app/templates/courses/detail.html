{% extends "base.html" %}

{% block title %}{{ course.title }} - Beatrice Gugger{% endblock %}

{% block content %}
<div class="course-detail">
    <a href="{{ url_for('courses.workshop_category', category_id=course.workshop_category_id) }}" class="back-link">
        <img src="{{ url_for('static', filename='images/Pfeil_links.png') }}" alt="Zurück" class="back-arrow">
    </a>
    
    <h1 class="editable-text" data-entity="course" data-entity-id="{{ course.id }}" data-field="title" contenteditable="{{ 'true' if current_user.is_authenticated else 'false' }}">{{ course.title }}</h1>
    
    {% if course.image_path %}
    <div class="course-image editable-image" data-entity="course" data-entity-id="{{ course.id }}" data-field="image">
        <img src="{{ url_for('uploaded_file', filename=course.image_path) }}" alt="{{ course.title }}">
    </div>
    {% endif %}
    
    {% if course.description %}
    <div class="course-description editable-text" data-entity="course" data-entity-id="{{ course.id }}" data-field="content" contenteditable="{{ 'true' if current_user.is_authenticated else 'false' }}">
        {{ course.description|safe }}
    </div>
    {% endif %}
    
    <div class="course-meta">
        {% if course.date %}
        <p><strong>Datum:</strong> {{ course.date.strftime('%d.%m.%Y %H:%M') }}</p>
        {% endif %}
        
        {% if course.location %}
        <p><strong>Ort:</strong> {{ course.location }}</p>
        {% endif %}
        
        {% if course.max_participants %}
        <p><strong>Teilnehmer:</strong> {{ course.registration_count }} / {{ course.max_participants }}</p>
        {% endif %}
    </div>
    
    {% if course.is_full %}
    <div class="alert alert-warning">
        <p>Dieser Kurs ist bereits voll. Du kannst dich auf die Warteliste setzen lassen.</p>
    </div>
    {% endif %}
    
    <div class="registration-form">
        <h2 id="registration-title">{% if course.is_full %}Warteliste{% else %}Anmeldung{% endif %} für <span id="person-count">1</span> <span id="person-label">Person</span></h2>
        <form method="POST" action="{{ url_for('courses.register', course_id=course.id) }}" onsubmit="return validateRegistrationForm(this)">
            <div class="form-group participant-selector">
                <label>Anzahl Personen</label>
                <div class="number-input">
                    <button type="button" class="num-btn num-down" onclick="changeCount(-1)">▼</button>
                    <input type="number" id="num_participants" name="num_participants" value="1" min="1" readonly>
                    <button type="button" class="num-btn num-up" onclick="changeCount(1)">▲</button>
                </div>
                {% if course.max_participants and not course.is_full %}
                <small class="form-hint">Freie Plätze: <span id="spots-available">{{ course.spots_available }}</span></small>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="vorname">Vorname *</label>
                <input type="text" id="vorname" name="vorname" required>
            </div>
            
            <div class="form-group">
                <label for="name">Name *</label>
                <input type="text" id="name" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="telefonnummer">Telefonnummer (für Bestätigung) *</label>
                <input type="tel" id="telefonnummer" name="telefonnummer" required>
            </div>
            
            <div class="form-group">
                <label for="email">E-Mail (optional)</label>
                <input type="email" id="email" name="email">
            </div>
            
            <!-- Honeypot field - hidden from humans, bots will fill it -->
            <div class="form-group" style="position: absolute; left: -9999px; opacity: 0; height: 0; overflow: hidden;" aria-hidden="true">
                <label for="website">Website (leave empty)</label>
                <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
            </div>
            
            <button type="submit" class="btn btn-primary{% if course.is_full %} btn-waitlist{% endif %}">
                {% if course.is_full %}Auf Warteliste setzen{% else %}Jetzt anmelden{% endif %}
            </button>
        </form>
    </div>
    
    <style>
    .back-link {
        display: inline-block;
        margin-bottom: 10px;
    }
    .back-arrow {
        width: 50px;
        height: auto;
        transition: transform 0.2s ease;
    }
    .back-link:hover .back-arrow {
        transform: translateX(-5px);
    }
    .participant-selector {
        margin-bottom: 20px;
    }
    .number-input {
        display: flex;
        align-items: center;
        gap: 5px;
        width: fit-content;
    }
    .number-input input {
        width: 60px;
        text-align: center;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 8px;
        border: 1px solid #333;
        border-radius: 4px;
        background: transparent;
        -webkit-appearance: textfield;
        -moz-appearance: textfield;
        appearance: textfield;
    }
    .number-input input::-webkit-inner-spin-button,
    .number-input input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .num-btn {
        width: 36px;
        height: 36px;
        border: 1px solid #333;
        border-radius: 4px;
        background: transparent;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .num-btn:hover {
        background: #e0e0e0;
    }
    .num-btn:active {
        background: #d0d0d0;
    }
    </style>
    
    <script>
    const spotsAvailable = {{ course.spots_available if course.spots_available is not none else 'null' }};
    const isFull = {{ 'true' if course.is_full else 'false' }};
    
    function changeCount(delta) {
        const input = document.getElementById('num_participants');
        let value = parseInt(input.value) + delta;
        if (value < 1) value = 1;
        input.value = value;
        updateLabels(value);
    }
    
    function updateLabels(count) {
        document.getElementById('person-count').textContent = count;
        document.getElementById('person-label').textContent = count === 1 ? 'Person' : 'Personen';
    }
    function validateRegistrationForm(form) {
        const phone = form.telefonnummer.value.trim();
        const email = form.email.value.trim();
        
        // Validate phone - remove formatting and check
        const cleanedPhone = phone.replace(/[\s\-\.\(\)]+/g, '');
        if (!/^\+?\d{9,15}$/.test(cleanedPhone)) {
            alert('Bitte geben Sie eine gültige Telefonnummer ein.');
            form.telefonnummer.focus();
            return false;
        }
        
        // Validate email if provided
        if (email && !/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
            alert('Bitte geben Sie eine gültige E-Mail-Adresse ein.');
            form.email.focus();
            return false;
        }
        
        return true;
    }
    </script>
</div>
{% endblock %}
