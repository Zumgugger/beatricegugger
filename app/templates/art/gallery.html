{% extends "base.html" %}

{% block title %}{{ category.title }} - Art - Beatrice Gugger{% endblock %}

{% block content %}
<div class="gallery-page">
    <h1>{{ category.title }}</h1>
    
    {% if category.description %}
    <p class="gallery-description">{{ category.description }}</p>
    {% endif %}
    
    {% if current_user.is_authenticated %}
    <div class="admin-controls">
        <button class="btn btn-add" onclick="showImageUploadForm()">+ Bilder hinzuf√ºgen</button>
    </div>
    
    <!-- Image Upload Form (hidden by default) -->
    <div id="image-upload-form" class="new-item-form" style="display: none;">
        <h3>Bilder hochladen</h3>
        <form action="{{ url_for('admin.api_upload_art_images', category_id=category.id) }}" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="images">Bilder ausw√§hlen (mehrere m√∂glich)</label>
                <input type="file" name="images" id="images" accept="image/*" multiple required>
            </div>
            <div class="form-group">
                <label for="caption">Bildunterschrift (optional, f√ºr alle Bilder)</label>
                <input type="text" name="caption" id="caption">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Hochladen</button>
                <button type="button" class="btn btn-secondary" onclick="hideImageUploadForm()">Abbrechen</button>
            </div>
        </form>
    </div>
    {% endif %}
    
    <div class="gallery-container">
        {% if images %}
        <div class="gallery-viewer">
            <button class="gallery-nav prev" id="prevBtn" aria-label="Vorheriges Bild">
                <img src="{{ url_for('static', filename='images/Pfeil links.png') }}" alt="Zur√ºck">
            </button>
            
            <div class="gallery-images">
                {% for image in images %}
                <div class="gallery-image {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}" data-image-id="{{ image.id }}">
                    {% if current_user.is_authenticated %}
                    <button class="btn-icon btn-delete gallery-delete" onclick="deleteImage({{ image.id }}, event)" title="Bild l√∂schen">üóëÔ∏è</button>
                    {% endif %}
                    <img src="{{ url_for('uploaded_file', filename=image.image_path) }}" alt="{{ image.caption or category.title }}">
                    {% if image.caption %}
                    <p class="image-caption">{{ image.caption }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <button class="gallery-nav next" id="nextBtn" aria-label="N√§chstes Bild">
                <img src="{{ url_for('static', filename='images/Pfeil rechts.png') }}" alt="Weiter">
            </button>
        </div>
        
        <div class="gallery-counter">
            <span id="currentImage">1</span> / <span id="totalImages">{{ images|length }}</span>
        </div>
        {% else %}
        <p>Keine Bilder in dieser Kategorie.</p>
        {% endif %}
    </div>
</div>

{% if current_user.is_authenticated %}
<script>
function showImageUploadForm() {
    document.getElementById('image-upload-form').style.display = 'block';
}

function hideImageUploadForm() {
    document.getElementById('image-upload-form').style.display = 'none';
}

async function deleteImage(imageId, event) {
    event.stopPropagation();
    if (!confirm('Dieses Bild wirklich l√∂schen?')) {
        return;
    }
    try {
        const resp = await fetch(`/admin/api/art-image/${imageId}`, { method: 'DELETE' });
        const data = await resp.json();
        if (data.success) {
            // Reload page to update gallery
            window.location.reload();
        } else {
            alert(data.message || 'Fehler beim L√∂schen');
        }
    } catch (err) {
        console.error(err);
        alert('Fehler beim L√∂schen');
    }
}
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/gallery.js') }}"></script>
{% endblock %}
