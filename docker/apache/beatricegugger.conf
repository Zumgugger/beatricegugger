# Apache2 Virtual Host Configuration for Beatrice Gugger
# 
# INSTALLATION:
#   sudo cp beatricegugger.conf /etc/apache2/sites-available/
#   sudo a2ensite beatricegugger.conf
#   sudo a2enmod proxy proxy_http headers rewrite ssl
#   sudo systemctl reload apache2
#
# SSL SETUP (run AFTER enabling this config):
#   sudo certbot --apache -d beatricegugger.ch -d www.beatricegugger.ch
#
# OR use DNS challenge if HTTP challenge fails:
#   sudo certbot certonly --manual --preferred-challenges dns -d beatricegugger.ch -d www.beatricegugger.ch

<VirtualHost *:80>
    ServerName beatricegugger.ch
    ServerAlias www.beatricegugger.ch

    # IMPORTANT: Let's Encrypt challenge directory
    # This MUST come before any ProxyPass directives
    DocumentRoot /var/www/html
    
    <Directory "/var/www/html/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>

    # Exclude acme-challenge from proxy
    ProxyPass /.well-known/acme-challenge/ !
    
    # After SSL is set up, this will redirect to HTTPS
    # Uncomment after running certbot:
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # Proxy to Flask app (temporary, until HTTPS is set up)
    ProxyPreserveHost On
    ProxyPass / http://127.0.0.1:5003/
    ProxyPassReverse / http://127.0.0.1:5003/

    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Host "beatricegugger.ch"

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    ErrorLog ${APACHE_LOG_DIR}/beatricegugger_error.log
    CustomLog ${APACHE_LOG_DIR}/beatricegugger_access.log combined
</VirtualHost>

# HTTPS Virtual Host - Certbot will create this automatically
# Or manually configure after getting certificate:
#
# <VirtualHost *:443>
#     ServerName beatricegugger.ch
#     ServerAlias www.beatricegugger.ch
#
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/beatricegugger.ch/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/beatricegugger.ch/privkey.pem
#     Include /etc/letsencrypt/options-ssl-apache.conf
#
#     ProxyPreserveHost On
#     ProxyPass / http://127.0.0.1:5003/
#     ProxyPassReverse / http://127.0.0.1:5003/
#
#     RequestHeader set X-Forwarded-Proto "https"
#     RequestHeader set X-Forwarded-Host "beatricegugger.ch"
#
#     Header always set X-Frame-Options "SAMEORIGIN"
#     Header always set X-Content-Type-Options "nosniff"
#     Header always set X-XSS-Protection "1; mode=block"
#     Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
#
#     ErrorLog ${APACHE_LOG_DIR}/beatricegugger_ssl_error.log
#     CustomLog ${APACHE_LOG_DIR}/beatricegugger_ssl_access.log combined
# </VirtualHost>
